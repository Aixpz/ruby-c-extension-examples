# SketchUp Ruby C/C++ æ‰©å±•å¼€å‘å®Œæ•´ä½¿ç”¨æŒ‡å—

## ğŸ“‹ ç›®å½•

1. [é¡¹ç›®æ¦‚è¿°](#é¡¹ç›®æ¦‚è¿°)
2. [é¡¹ç›®ç»“æ„è¯¦è§£](#é¡¹ç›®ç»“æ„è¯¦è§£)
3. [ç¯å¢ƒå‡†å¤‡](#ç¯å¢ƒå‡†å¤‡)
4. [Hello World ç¤ºä¾‹è¯¦è§£](#hello-world-ç¤ºä¾‹è¯¦è§£)
5. [SWIG ç¤ºä¾‹è¯¦è§£](#swig-ç¤ºä¾‹è¯¦è§£)
6. [Windows å¹³å°ç¼–è¯‘](#windows-å¹³å°ç¼–è¯‘)
7. [macOS å¹³å°ç¼–è¯‘](#macos-å¹³å°ç¼–è¯‘)
8. [è°ƒè¯•é…ç½®](#è°ƒè¯•é…ç½®)
9. [åœ¨ SketchUp ä¸­åŠ è½½æ‰©å±•](#åœ¨-sketchup-ä¸­åŠ è½½æ‰©å±•)
10. [å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ](#å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ)

---

## é¡¹ç›®æ¦‚è¿°

è¿™æ˜¯ä¸€ä¸ª**å®Œæ•´çš„ SketchUp Ruby C/C++ æ‰©å±•å¼€å‘ç¤ºä¾‹é¡¹ç›®**ï¼Œç”± Trimble Navigation Ltd. æä¾›ã€‚é¡¹ç›®åŒ…å«ï¼š

- âœ… **å®Œæ•´çš„ Ruby å¤´æ–‡ä»¶å’Œåº“æ–‡ä»¶**ï¼ˆæ”¯æŒ Ruby 1.8 åˆ° 3.2ï¼‰
- âœ… **ä¸¤ä¸ªå®Œæ•´çš„ç¤ºä¾‹é¡¹ç›®**ï¼ˆHello World å’Œ SWIGï¼‰
- âœ… **Visual Studio å’Œ Xcode é¡¹ç›®é…ç½®**
- âœ… **è¾…åŠ© Ruby è„šæœ¬**ç”¨äºåŠ è½½å’Œæµ‹è¯•æ‰©å±•
- âœ… **SWIG å·¥å…·**ç”¨äºè‡ªåŠ¨ç”Ÿæˆ Ruby ç»‘å®šä»£ç 

### é¡¹ç›®ç”¨é€”

è¿™ä¸ªé¡¹ç›®çš„ä¸»è¦ç›®çš„æ˜¯å¸®åŠ©å¼€å‘è€…ï¼š
1. å­¦ä¹ å¦‚ä½•ä¸º SketchUp åˆ›å»º Ruby C/C++ æ‰©å±•
2. ç†è§£ Ruby C API çš„åŸºæœ¬ç”¨æ³•
3. æŒæ¡ä½¿ç”¨ SWIG è¿›è¡Œè·¨è¯­è¨€ç»‘å®šçš„æ–¹æ³•
4. äº†è§£ä¸åŒ Ruby ç‰ˆæœ¬å’Œå¹³å°çš„ç¼–è¯‘é…ç½®

---

## é¡¹ç›®ç»“æ„è¯¦è§£

```
ruby-c-extension-examples/
â”œâ”€â”€ Hello World/                    # Hello World ç¤ºä¾‹é¡¹ç›®
â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”œâ”€â”€ SUEX_HelloWorld.cpp    # ä¸»æ‰©å±•æ–‡ä»¶ï¼Œå®šä¹‰ Init_SUEX_HelloWorld()
â”‚   â”‚   â””â”€â”€ RubyUtils/             # Ruby å·¥å…·å‡½æ•°
â”‚   â”‚       â”œâ”€â”€ RubyLib.h          # Ruby å¤´æ–‡ä»¶åŒ…è£…å’Œå…¼å®¹æ€§å®
â”‚   â”‚       â”œâ”€â”€ RubyUtils.h        # C++ ç±»å‹åˆ° Ruby VALUE çš„è½¬æ¢å‡½æ•°
â”‚   â”‚       â””â”€â”€ RubyUtils.cpp      # å®ç°æ–‡ä»¶
â”‚   â”œâ”€â”€ RubyExtension.def          # Windows DLL å¯¼å‡ºå®šä¹‰æ–‡ä»¶
â”‚   â”œâ”€â”€ Hello World.vcxproj         # Visual Studio é¡¹ç›®æ–‡ä»¶
â”‚   â””â”€â”€ SUEX_HelloWorld.xcodeproj/ # Xcode é¡¹ç›®æ–‡ä»¶
â”‚
â”œâ”€â”€ SUEX_UsingSWIG/                 # SWIG ç¤ºä¾‹é¡¹ç›®
â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”œâ”€â”€ MyNativeClass.h/cpp    # C++ åŸç”Ÿç±»
â”‚   â”‚   â”œâ”€â”€ INativeToRuby.h/cpp    # C++ æ¥å£ï¼ŒRuby å¯ä»¥ç»§æ‰¿
â”‚   â”‚   â””â”€â”€ Swig_output.cpp/h      # SWIG è‡ªåŠ¨ç”Ÿæˆçš„ç»‘å®šä»£ç 
â”‚   â”œâ”€â”€ Swig_input.i               # SWIG æ¥å£å®šä¹‰æ–‡ä»¶
â”‚   â””â”€â”€ SUEX_UsingSWIG.vcxproj     # Visual Studio é¡¹ç›®æ–‡ä»¶
â”‚
â”œâ”€â”€ Ruby/                           # è¾…åŠ© Ruby è„šæœ¬
â”‚   â”œâ”€â”€ launch_sketchup.rb         # åœ¨ SketchUp ä¸­åŠ è½½æ‰©å±•
â”‚   â”œâ”€â”€ SwigExample.rb             # SWIG ç¤ºä¾‹çš„ä½¿ç”¨ä»£ç 
â”‚   â””â”€â”€ inspect_strings.rb         # æ£€æŸ¥äºŒè¿›åˆ¶æ–‡ä»¶ä¸­çš„å­—ç¬¦ä¸²
â”‚
â”œâ”€â”€ ThirdParty/                     # ç¬¬ä¸‰æ–¹ä¾èµ–
â”‚   â”œâ”€â”€ include/ruby/               # Ruby å¤´æ–‡ä»¶ï¼ˆæŒ‰ç‰ˆæœ¬å’Œå¹³å°åˆ†ç±»ï¼‰
â”‚   â”‚   â”œâ”€â”€ 1.8/win32/, 2.0/win32_x64/, 2.7/mac/, 3.2/...
â”‚   â”œâ”€â”€ lib/                        # Ruby åº“æ–‡ä»¶
â”‚   â”‚   â”œâ”€â”€ win32/                  # Windows .lib æ–‡ä»¶
â”‚   â”‚   â””â”€â”€ mac/                    # macOS .framework æ–‡ä»¶
â”‚   â””â”€â”€ bin/win32/swig/             # SWIG å·¥å…·ï¼ˆWindowsï¼‰
â”‚
â”œâ”€â”€ RubyExtension.props             # é€šç”¨é¡¹ç›®å±æ€§é…ç½®
â”œâ”€â”€ Ruby 2.0 (x64).props           # Ruby 2.0 x64 é…ç½®
â”œâ”€â”€ Ruby 2.7 (x64).props            # Ruby 2.7 x64 é…ç½®
â”œâ”€â”€ Ruby 3.2 (x64).props            # Ruby 3.2 x64 é…ç½®
â”‚   ...ï¼ˆå…¶ä»–ç‰ˆæœ¬çš„ props æ–‡ä»¶ï¼‰
â”‚
â”œâ”€â”€ SketchUp Ruby C Extension Examples.sln  # Visual Studio è§£å†³æ–¹æ¡ˆ
â””â”€â”€ SketchUp Ruby C Extension Examples.xcworkspace/  # Xcode å·¥ä½œç©ºé—´
```

---

## ç¯å¢ƒå‡†å¤‡

### Windows å¹³å°

#### å¿…éœ€è½¯ä»¶

1. **Visual Studio 2022**ï¼ˆæ¨èï¼‰æˆ– Visual Studio 2019/2017
   - éœ€è¦å®‰è£… "ä½¿ç”¨ C++ çš„æ¡Œé¢å¼€å‘" å·¥ä½œè´Ÿè½½
   - é¡¹ç›®ä½¿ç”¨ `v143` å·¥å…·é›†ï¼ˆVS2022ï¼‰

2. **SketchUp**
   - æ ¹æ®ä½ è¦æ”¯æŒçš„ SketchUp ç‰ˆæœ¬å®‰è£…å¯¹åº”ç‰ˆæœ¬
   - é¡¹ç›®é…ç½®ä¸­é¢„è®¾äº†ä»¥ä¸‹ç‰ˆæœ¬çš„è·¯å¾„ï¼š
     - SketchUp 2013 (Ruby 1.8)
     - SketchUp 2015 (Ruby 2.0)
     - SketchUp 2016 (Ruby 2.0 x64)
     - SketchUp 2017 (Ruby 2.2/2.5/2.7/3.2)

3. **SWIG**ï¼ˆä»…ç”¨äº SWIG ç¤ºä¾‹ï¼‰
   - é¡¹ç›®å·²åŒ…å« Windows ç‰ˆæœ¬çš„ SWIGï¼š`ThirdParty/bin/win32/swig/swig.exe`
   - æˆ–ä» [SWIG å®˜ç½‘](http://www.swig.org/) ä¸‹è½½å®‰è£…

#### å¯é€‰é…ç½®

- **Ruby å¼€å‘ç¯å¢ƒ**ï¼ˆç”¨äºæµ‹è¯• Ruby è„šæœ¬ï¼‰
- **Git**ï¼ˆç”¨äºç‰ˆæœ¬æ§åˆ¶ï¼‰

### macOS å¹³å°

#### å¿…éœ€è½¯ä»¶

1. **Xcode 14** æˆ–æ›´é«˜ç‰ˆæœ¬
   - ä» App Store å®‰è£…
   - å®‰è£…å‘½ä»¤è¡Œå·¥å…·ï¼š`xcode-select --install`

2. **SketchUp for Mac**
   - æ ¹æ®ä½ è¦æ”¯æŒçš„ç‰ˆæœ¬å®‰è£…

3. **SWIG**ï¼ˆä»…ç”¨äº SWIG ç¤ºä¾‹ï¼‰
   - ä½¿ç”¨ Homebrew å®‰è£…ï¼š`brew install swig`
   - æˆ–ä» [SWIG å®˜ç½‘](http://www.swig.org/) ä¸‹è½½

---

## Hello World ç¤ºä¾‹è¯¦è§£

### ä»£ç ç»“æ„

#### 1. ä¸»æ‰©å±•æ–‡ä»¶ï¼š`SUEX_HelloWorld.cpp`

```cpp
#include "RubyUtils/RubyUtils.h"

// å®šä¹‰ä¸€ä¸ª Ruby æ–¹æ³•ï¼šè¿”å› "Hello World!" å­—ç¬¦ä¸²
VALUE hello_world() {
  return GetRubyInterface("Hello World!");
}

// å®šä¹‰ä¸€ä¸ª Ruby æ–¹æ³•ï¼šè¿”å› Ruby å¹³å°ä¿¡æ¯
VALUE ruby_platform() {
  return GetRubyInterface(RUBY_PLATFORM);
}

// æ‰©å±•åˆå§‹åŒ–å‡½æ•° - å¿…é¡»å‘½åä¸º Init_<é¡¹ç›®å>
extern "C"
void Init_SUEX_HelloWorld()
{
  // å®šä¹‰ Ruby æ¨¡å—
  VALUE mSUEX_HelloWorld = rb_define_module("SUEX_HelloWorld");
  
  // å®šä¹‰æ¨¡å—å¸¸é‡
  rb_define_const(mSUEX_HelloWorld, "CEXT_VERSION", GetRubyInterface("1.0.0"));
  
  // å®šä¹‰æ¨¡å—æ–¹æ³•ï¼ˆé™æ€æ–¹æ³•ï¼‰
  rb_define_module_function(mSUEX_HelloWorld, "hello_world", VALUEFUNC(hello_world), 0);
  rb_define_module_function(mSUEX_HelloWorld, "ruby_platform", VALUEFUNC(ruby_platform), 0);
}
```

**å…³é”®ç‚¹ï¼š**
- `Init_SUEX_HelloWorld()` å‡½æ•°åå¿…é¡»ä¸é¡¹ç›®ååŒ¹é…ï¼ˆ`Init_` + é¡¹ç›®åï¼‰
- ä½¿ç”¨ `rb_define_module()` åˆ›å»º Ruby æ¨¡å—
- ä½¿ç”¨ `rb_define_module_function()` å®šä¹‰æ¨¡å—æ–¹æ³•
- ä½¿ç”¨ `VALUEFUNC()` å®å°† C++ å‡½æ•°è½¬æ¢ä¸º Ruby å¯è°ƒç”¨çš„å‡½æ•°æŒ‡é’ˆ
- æœ€åä¸€ä¸ªå‚æ•° `0` è¡¨ç¤ºæ–¹æ³•ä¸æ¥å—å‚æ•°

#### 2. Ruby å·¥å…·å‡½æ•°ï¼š`RubyUtils.h` å’Œ `RubyUtils.cpp`

è¿™äº›æ–‡ä»¶æä¾›äº† C++ ç±»å‹åˆ° Ruby `VALUE` çš„è½¬æ¢å‡½æ•°ï¼š

```cpp
// å­—ç¬¦ä¸²
VALUE GetRubyInterface(const char *s);

// å¸ƒå°”å€¼
inline VALUE GetRubyInterface(bool bValue) {
  return bValue ? Qtrue : Qfalse;
}

// æ•°å­—ç±»å‹ï¼ˆint, long, double, float ç­‰ï¼‰
inline VALUE GetRubyInterface(int value) {
  return rb_int2inum((long) value);
}
```

#### 3. Ruby å…¼å®¹æ€§å¤´æ–‡ä»¶ï¼š`RubyLib.h`

è¿™ä¸ªæ–‡ä»¶å¤„ç†äº†ï¼š
- Ruby 1.8 å’Œ 2.0+ ä¹‹é—´çš„ API å·®å¼‚
- Windows å’Œ macOS å¹³å°çš„å…¼å®¹æ€§
- Visual Studio ç¼–è¯‘å™¨çš„ç‰¹æ®Šé…ç½®ï¼ˆ`/MT` vs `/MD`ï¼‰
- Ruby å¤´æ–‡ä»¶ä¸ C++ æ ‡å‡†åº“çš„å†²çª

### ç¼–è¯‘è¾“å‡º

ç¼–è¯‘æˆåŠŸåï¼Œä¼šç”Ÿæˆï¼š
- **Windows**: `SUEX_HelloWorld.so`ï¼ˆåŠ¨æ€é“¾æ¥åº“ï¼‰
- **macOS**: `SUEX_HelloWorld.bundle`ï¼ˆåŠ¨æ€åº“åŒ…ï¼‰

### åœ¨ Ruby ä¸­ä½¿ç”¨

```ruby
# åŠ è½½æ‰©å±•
require 'SUEX_HelloWorld'

# è°ƒç”¨æ¨¡å—æ–¹æ³•
puts SUEX_HelloWorld.hello_world      # => "Hello World!"
puts SUEX_HelloWorld.ruby_platform   # => "x64-mswin64_140" (Windows) æˆ– "x86_64-darwin17" (macOS)

# è®¿é—®å¸¸é‡
puts SUEX_HelloWorld::CEXT_VERSION   # => "1.0.0"
```

---

## SWIG ç¤ºä¾‹è¯¦è§£

SWIGï¼ˆSimplified Wrapper and Interface Generatorï¼‰æ˜¯ä¸€ä¸ªå·¥å…·ï¼Œå¯ä»¥è‡ªåŠ¨ç”Ÿæˆ Ruby ç»‘å®šä»£ç ï¼Œè®©ä½ èƒ½å¤Ÿï¼š
- åœ¨ Ruby ä¸­ä½¿ç”¨ C++ ç±»å’Œå¯¹è±¡
- è®© Ruby ç±»ç»§æ‰¿ C++ æ¥å£ï¼ˆä½¿ç”¨ Directors åŠŸèƒ½ï¼‰
- å®ç° C++ å’Œ Ruby ä¹‹é—´çš„åŒå‘è°ƒç”¨

### ä»£ç ç»“æ„

#### 1. C++ æ¥å£ï¼š`INativeToRuby.h`

```cpp
class INativeToRuby
{
public:
  INativeToRuby();
  virtual ~INativeToRuby();
  
  // çº¯è™šå‡½æ•°ï¼ŒRuby ç±»å¯ä»¥å®ç°è¿™ä¸ªæ–¹æ³•
  virtual void CallFromNative(const std::string& message) = 0;
};
```

#### 2. C++ åŸç”Ÿç±»ï¼š`MyNativeClass.h/cpp`

```cpp
class MyNativeClass
{
public:
  MyNativeClass(INativeToRuby& ri);
  ~MyNativeClass();
  
  // è¿™ä¸ªæ–¹æ³•ä¼šè°ƒç”¨ä¼ å…¥çš„æ¥å£å¯¹è±¡çš„æ–¹æ³•
  void CallBackToRuby(const std::string& message);
  
private:
  INativeToRuby& ruby_interface_;
};
```

#### 3. SWIG æ¥å£æ–‡ä»¶ï¼š`Swig_input.i`

```swig
%module(directors=1) SUEX_UsingSWIG  // å¯ç”¨ directors åŠŸèƒ½

%{
#include "MyNativeClass.h"
#include "INativeToRuby.h"
%}

%include std_string.i  // åŒ…å« std::string çš„ç±»å‹æ˜ å°„

%include "MyNativeClass.h"

%feature("director") INativeToRuby;  // å¯ç”¨ directorï¼Œå…è®¸ Ruby ç»§æ‰¿
%include "INativeToRuby.h"
```

**å…³é”®é…ç½®ï¼š**
- `directors=1`ï¼šå¯ç”¨ directors åŠŸèƒ½ï¼Œå…è®¸ Ruby ç±»ç»§æ‰¿ C++ æ¥å£
- `%include std_string.i`ï¼šå¤„ç† `std::string` ç±»å‹
- `%feature("director")`ï¼šæ ‡è®°æ¥å£ç±»ï¼Œå…è®¸ Ruby å®ç°

### ç¼–è¯‘æµç¨‹

1. **SWIG ç”Ÿæˆç»‘å®šä»£ç **
   - Visual Studio é¡¹ç›®é…ç½®äº†è‡ªå®šä¹‰æ„å»ºæ­¥éª¤
   - ç¼–è¯‘æ—¶è‡ªåŠ¨è¿è¡Œï¼š`swig.exe -c++ -ruby -o Swig_output.cpp Swig_input.i`
   - ç”Ÿæˆ `Swig_output.cpp` å’Œ `Swig_output.h`

2. **ç¼–è¯‘ C++ ä»£ç **
   - ç¼–è¯‘ `MyNativeClass.cpp`ã€`INativeToRuby.cpp` å’Œ `Swig_output.cpp`
   - é“¾æ¥ Ruby åº“ï¼Œç”Ÿæˆ `.so` æˆ– `.bundle`

### åœ¨ Ruby ä¸­ä½¿ç”¨

å‚è€ƒ `Ruby/SwigExample.rb`ï¼š

```ruby
# åŠ è½½æ‰©å±•
require 'SUEX_UsingSWIG'

# åˆ›å»ºä¸€ä¸ª Ruby ç±»ï¼Œç»§æ‰¿ C++ æ¥å£
class FromNative < SUEX_UsingSWIG::INativeToRuby
  def initialize
    super()  # è°ƒç”¨çˆ¶ç±»æ„é€ å‡½æ•°
  end
  
  def CallFromNative(message)
    UI.messagebox(message)  # å®ç°æ¥å£æ–¹æ³•
  end
end

# åˆ›å»º Ruby å¯¹è±¡
fn = FromNative.new

# åˆ›å»º C++ å¯¹è±¡ï¼Œä¼ å…¥ Ruby å¯¹è±¡
native_obj = SUEX_UsingSWIG::MyNativeClass.new(fn)

# è°ƒç”¨ C++ æ–¹æ³•ï¼Œå®ƒä¼šå›è°ƒ Ruby æ–¹æ³•
native_obj.CallBackToRuby('This came from Ruby')
```

**å·¥ä½œæµç¨‹ï¼š**
1. Ruby åˆ›å»º `FromNative` å¯¹è±¡ï¼ˆå®ç°äº† C++ æ¥å£ï¼‰
2. å°† Ruby å¯¹è±¡ä¼ ç»™ C++ æ„é€ å‡½æ•°
3. C++ è°ƒç”¨ `CallBackToRuby()`
4. C++ å†…éƒ¨è°ƒç”¨ `ruby_interface_.CallFromNative()`
5. è¿™ä¼šè§¦å‘ Ruby çš„ `CallFromNative()` æ–¹æ³•
6. Ruby æ–¹æ³•æ‰§è¡Œï¼ˆæ˜¾ç¤ºæ¶ˆæ¯æ¡†ï¼‰

---

## Windows å¹³å°ç¼–è¯‘

### ä½¿ç”¨ Visual Studio

#### æ­¥éª¤ 1ï¼šæ‰“å¼€è§£å†³æ–¹æ¡ˆ

1. åŒå‡» `SketchUp Ruby C Extension Examples.sln`
2. æˆ–åœ¨ Visual Studio ä¸­é€‰æ‹©ï¼š**æ–‡ä»¶ > æ‰“å¼€ > é¡¹ç›®/è§£å†³æ–¹æ¡ˆ**

#### æ­¥éª¤ 2ï¼šé€‰æ‹©æ„å»ºé…ç½®

åœ¨ Visual Studio é¡¶éƒ¨å·¥å…·æ ï¼š

1. **é€‰æ‹©é…ç½®**ï¼š`Debug (2.7)` æˆ– `Release (2.7)`ï¼ˆæ ¹æ®ä½ çš„ SketchUp ç‰ˆæœ¬é€‰æ‹©ï¼‰
2. **é€‰æ‹©å¹³å°**ï¼š`x64`ï¼ˆç°ä»£ SketchUp éƒ½æ˜¯ 64 ä½ï¼‰

**å¯ç”¨çš„é…ç½®ï¼š**
- `Debug (1.8)|Win32` - SketchUp 2013
- `Debug (2.0)|x64` - SketchUp 2016
- `Debug (2.2)|x64` - SketchUp 2017
- `Debug (2.5)|x64` - SketchUp 2017
- `Debug (2.7)|x64` - SketchUp 2017+
- `Debug (3.2)|x64` - SketchUp 2023+

#### æ­¥éª¤ 3ï¼šç¼–è¯‘é¡¹ç›®

1. åœ¨**è§£å†³æ–¹æ¡ˆèµ„æºç®¡ç†å™¨**ä¸­ï¼Œå³é”®ç‚¹å‡» `SUEX_HelloWorld` é¡¹ç›®
2. é€‰æ‹© **ç”Ÿæˆ** æˆ–æŒ‰ `Ctrl+Shift+B`
3. æŸ¥çœ‹**è¾“å‡º**çª—å£ç¡®è®¤ç¼–è¯‘æˆåŠŸ

#### æ­¥éª¤ 4ï¼šæŸ¥æ‰¾è¾“å‡ºæ–‡ä»¶

ç¼–è¯‘æˆåŠŸåï¼Œæ‰©å±•æ–‡ä»¶ä½äºï¼š
```
é¡¹ç›®æ ¹ç›®å½•/
  â””â”€â”€ Debug (2.7)/
      â””â”€â”€ x64/
          â””â”€â”€ SUEX_HelloWorld.so
```

### é¡¹ç›®é…ç½®è¯¦è§£

#### Ruby ç‰ˆæœ¬é…ç½®ï¼ˆ`.props` æ–‡ä»¶ï¼‰

æ¯ä¸ª Ruby ç‰ˆæœ¬éƒ½æœ‰ä¸€ä¸ªå¯¹åº”çš„ `.props` æ–‡ä»¶ï¼Œä¾‹å¦‚ `Ruby 2.7 (x64).props`ï¼š

```xml
<ClCompile>
  <!-- æŒ‡å®š Ruby å¤´æ–‡ä»¶è·¯å¾„ -->
  <AdditionalIncludeDirectories>
    $(SolutionDir)ThirdParty\include\ruby\2.7\win32_x64
  </AdditionalIncludeDirectories>
</ClCompile>
<Link>
  <!-- æŒ‡å®š Ruby åº“æ–‡ä»¶è·¯å¾„å’Œåº“å -->
  <AdditionalLibraryDirectories>
    $(SolutionDir)ThirdParty\lib\win32
  </AdditionalLibraryDirectories>
  <AdditionalDependencies>
    x64-msvcrt-ruby270.lib
  </AdditionalDependencies>
</Link>
```

#### é€šç”¨é…ç½®ï¼ˆ`RubyExtension.props`ï¼‰

```xml
<PropertyGroup>
  <TargetExt>.so</TargetExt>  <!-- è¾“å‡ºæ–‡ä»¶æ‰©å±•å -->
</PropertyGroup>
<ClCompile>
  <AdditionalIncludeDirectories>
    $(ProjectDir)src;$(ProjectDir)
  </AdditionalIncludeDirectories>
  <WarningLevel>Level3</WarningLevel>
  <TreatWarningAsError>true</TreatWarningAsError>
</ClCompile>
<Link>
  <ModuleDefinitionFile>.\RubyExtension.def</ModuleDefinitionFile>
</Link>
```

#### DLL å¯¼å‡ºæ–‡ä»¶ï¼ˆ`RubyExtension.def`ï¼‰

```def
LIBRARY
EXPORTS
    Init_SUEX_HelloWorld  <!-- å¿…é¡»å¯¼å‡º Init å‡½æ•° -->
```

**é‡è¦ï¼š** é¡¹ç›®åã€`Init_*()` å‡½æ•°åå’Œ `.def` æ–‡ä»¶ä¸­çš„å¯¼å‡ºåå¿…é¡»ä¸€è‡´ï¼

### è¿è¡Œæ—¶åº“é…ç½®ï¼ˆ`/MD` vs `/MT`ï¼‰

**é—®é¢˜ï¼š** SketchUp ä½¿ç”¨åŠ¨æ€ CRTï¼ˆ`/MD`ï¼‰ï¼Œä½†å¦‚æœä½ æƒ³é¿å…ä¾èµ– VC++ Runtimeï¼Œå¯ä»¥ä½¿ç”¨é™æ€ CRTï¼ˆ`/MT`ï¼‰ã€‚

**é»˜è®¤é…ç½®ï¼š** é¡¹ç›®ä½¿ç”¨ `/MD`ï¼ˆå¤šçº¿ç¨‹ DLLï¼‰

**åˆ‡æ¢åˆ° `/MT`ï¼š**
1. é¡¹ç›®å±æ€§ > C/C++ > ä»£ç ç”Ÿæˆ > è¿è¡Œæ—¶åº“
2. é€‰æ‹© "å¤šçº¿ç¨‹ (/MT)" æˆ– "å¤šçº¿ç¨‹è°ƒè¯• (/MTd)"
3. æ³¨æ„ï¼šå¯èƒ½éœ€è¦ä¿®æ”¹ `RubyLib.h` ä¸­çš„å®å®šä¹‰ï¼ˆå‚è€ƒ README.mdï¼‰

---

## macOS å¹³å°ç¼–è¯‘

### ä½¿ç”¨ Xcode

#### æ­¥éª¤ 1ï¼šæ‰“å¼€é¡¹ç›®

1. åŒå‡» `SUEX_HelloWorld.xcodeproj`
2. æˆ–ä½¿ç”¨å·¥ä½œç©ºé—´ï¼š`SketchUp Ruby C Extension Examples.xcworkspace`

#### æ­¥éª¤ 2ï¼šé€‰æ‹©æ„å»ºç›®æ ‡

1. åœ¨ Xcode é¡¶éƒ¨å·¥å…·æ ï¼Œç‚¹å‡» **Scheme** ä¸‹æ‹‰èœå•
2. é€‰æ‹©å¯¹åº”çš„ Ruby ç‰ˆæœ¬ï¼Œä¾‹å¦‚ï¼š
   - `SUEX_HelloWorld (Ruby 2.0)`
   - `SUEX_HelloWorld (Ruby 2.7)`
   - `SUEX_HelloWorld (Ruby 3.2)`

#### æ­¥éª¤ 3ï¼šç¼–è¯‘é¡¹ç›®

1. æŒ‰ `Cmd+B` æˆ–é€‰æ‹© **Product > Build**
2. æŸ¥çœ‹æ„å»ºæ—¥å¿—ç¡®è®¤æˆåŠŸ

#### æ­¥éª¤ 4ï¼šæŸ¥æ‰¾è¾“å‡ºæ–‡ä»¶

ç¼–è¯‘æˆåŠŸåï¼Œæ‰©å±•æ–‡ä»¶ä½äºï¼š
```
é¡¹ç›®æ ¹ç›®å½•/
  â””â”€â”€ Debug (2.7)/
      â””â”€â”€ SUEX_HelloWorld.bundle
```

### æ£€æŸ¥äºŒè¿›åˆ¶æ–‡ä»¶

ä½¿ç”¨ `macOS.md` ä¸­æåˆ°çš„å‘½ä»¤ï¼š

```bash
# æ£€æŸ¥æ¶æ„
file SUEX_HelloWorld.bundle
# è¾“å‡ºï¼šMach-O universal binary with 2 architectures: [x86_64] [arm64]

# æ£€æŸ¥æœ€ä½ç³»ç»Ÿç‰ˆæœ¬ï¼ˆx86_64ï¼‰
otool -arch x86_64 -l SUEX_HelloWorld.bundle | grep -A 5 LC_VERSION_MIN_MACOSX

# æ£€æŸ¥æœ€ä½ç³»ç»Ÿç‰ˆæœ¬ï¼ˆarm64ï¼‰
otool -arch arm64 -l SUEX_HelloWorld.bundle | grep -A 5 LC_BUILD_VERSION
```

---

## è°ƒè¯•é…ç½®

### Visual Studio è°ƒè¯•è®¾ç½®

é¡¹ç›®å·²é¢„é…ç½®è°ƒè¯•è®¾ç½®ï¼Œä¼šè‡ªåŠ¨å¯åŠ¨ SketchUp å¹¶åŠ è½½æ‰©å±•ã€‚

#### æŸ¥çœ‹/ä¿®æ”¹è°ƒè¯•é…ç½®

1. å³é”®ç‚¹å‡»é¡¹ç›® > **å±æ€§**
2. é€‰æ‹© **è°ƒè¯•**
3. æŸ¥çœ‹ä»¥ä¸‹è®¾ç½®ï¼š

**å‘½ä»¤** (`LocalDebuggerCommand`)ï¼š
```
$(ProgramW6432)\SketchUp\SketchUp 2017\SketchUp.exe
```

**å‘½ä»¤å‚æ•°** (`LocalDebuggerCommandArguments`)ï¼š
```
-RubyStartup "$(SolutionDir)Ruby\launch_sketchup.rb" -RubyStartupArg "$(Configuration):$(PlatformTarget)"
```

#### è°ƒè¯•æ­¥éª¤

1. åœ¨ C++ ä»£ç ä¸­è®¾ç½®æ–­ç‚¹
2. æŒ‰ `F5` å¯åŠ¨è°ƒè¯•
3. Visual Studio ä¼šï¼š
   - å¯åŠ¨ SketchUp
   - è‡ªåŠ¨åŠ è½½ç¼–è¯‘å¥½çš„æ‰©å±•
   - åœ¨æ–­ç‚¹å¤„æš‚åœ

#### ä¿®æ”¹ SketchUp è·¯å¾„

å¦‚æœ SketchUp å®‰è£…åœ¨ä¸åŒä½ç½®ï¼Œä¿®æ”¹é¡¹ç›®å±æ€§ä¸­çš„ `LocalDebuggerCommand`ã€‚

### Xcode è°ƒè¯•

1. åœ¨ä»£ç ä¸­è®¾ç½®æ–­ç‚¹
2. é€‰æ‹© **Product > Scheme > Edit Scheme**
3. åœ¨ **Run** æ ‡ç­¾é¡µé…ç½®å¯æ‰§è¡Œæ–‡ä»¶è·¯å¾„
4. æŒ‰ `Cmd+R` è¿è¡Œ

---

## åœ¨ SketchUp ä¸­åŠ è½½æ‰©å±•

### æ–¹æ³• 1ï¼šä½¿ç”¨ launch_sketchup.rbï¼ˆæ¨èï¼‰

è¿™ä¸ªè„šæœ¬ä¼šè‡ªåŠ¨æŸ¥æ‰¾å¹¶åŠ è½½ç¼–è¯‘å¥½çš„æ‰©å±•ã€‚

#### åœ¨ SketchUp Ruby æ§åˆ¶å°ä¸­è¿è¡Œï¼š

```ruby
# è®¾ç½®æ„å»ºé…ç½®ï¼ˆæ ¹æ®ä½ çš„ç¼–è¯‘é…ç½®ä¿®æ”¹ï¼‰
RELEASE = "Debug (2.7)"

# åŠ è½½å¯åŠ¨è„šæœ¬
load "é¡¹ç›®è·¯å¾„/Ruby/launch_sketchup.rb"
```

#### æˆ–é€šè¿‡å‘½ä»¤è¡Œå‚æ•°ï¼š

Visual Studio è°ƒè¯•é…ç½®å·²è®¾ç½®ï¼Œä¼šè‡ªåŠ¨ä¼ é€’å‚æ•°ã€‚

#### è„šæœ¬å·¥ä½œåŸç†ï¼š

`Ruby/launch_sketchup.rb` ä¼šï¼š
1. è§£æé…ç½®å‚æ•°ï¼ˆ`Debug (2.7):x64`ï¼‰
2. æŸ¥æ‰¾å¯¹åº”ç›®å½•ä¸‹çš„ `.so` æˆ– `.bundle` æ–‡ä»¶
3. è‡ªåŠ¨ `require` æ‰€æœ‰æ‰¾åˆ°çš„æ‰©å±•
4. è¾“å‡ºåŠ è½½æ—¥å¿—

### æ–¹æ³• 2ï¼šæ‰‹åŠ¨åŠ è½½

```ruby
# Windows
require "C:/å®Œæ•´è·¯å¾„/Debug (2.7)/x64/SUEX_HelloWorld.so"

# macOS
require "/å®Œæ•´è·¯å¾„/Debug (2.7)/SUEX_HelloWorld.bundle"

# æµ‹è¯•
puts SUEX_HelloWorld.hello_world
```

### æ–¹æ³• 3ï¼šå®‰è£…åˆ° SketchUp æ’ä»¶ç›®å½•

1. **Windows**ï¼š
   ```
   C:\Users\ç”¨æˆ·å\AppData\Roaming\SketchUp\SketchUp 2017\SketchUp\Plugins\
   ```

2. **macOS**ï¼š
   ```
   ~/Library/Application Support/SketchUp 2017/SketchUp/Plugins/
   ```

3. åˆ›å»ºåŠ è½½è„šæœ¬ `your_extension_loader.rb`ï¼š
   ```ruby
   # è·å–è„šæœ¬æ‰€åœ¨ç›®å½•
   extension_path = File.dirname(__FILE__)
   require File.join(extension_path, "SUEX_HelloWorld.so")  # æˆ– .bundle
   ```

---

## å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ

### 1. ç¼–è¯‘é”™è¯¯ï¼šæ‰¾ä¸åˆ° Ruby å¤´æ–‡ä»¶

**é”™è¯¯ä¿¡æ¯ï¼š**
```
fatal error C1083: æ— æ³•æ‰“å¼€åŒ…æ‹¬æ–‡ä»¶: "ruby.h": No such file or directory
```

**è§£å†³æ–¹æ¡ˆï¼š**
- æ£€æŸ¥é¡¹ç›®æ˜¯å¦å¼•ç”¨äº†æ­£ç¡®çš„ `.props` æ–‡ä»¶
- ç¡®è®¤ `ThirdParty/include/ruby/ç‰ˆæœ¬/å¹³å°/` ç›®å½•å­˜åœ¨
- åœ¨é¡¹ç›®å±æ€§ä¸­æ£€æŸ¥åŒ…å«ç›®å½•è®¾ç½®

### 2. é“¾æ¥é”™è¯¯ï¼šæ‰¾ä¸åˆ° Ruby åº“

**é”™è¯¯ä¿¡æ¯ï¼š**
```
error LNK2019: æ— æ³•è§£æçš„å¤–éƒ¨ç¬¦å·
```

**è§£å†³æ–¹æ¡ˆï¼š**
- æ£€æŸ¥ `.props` æ–‡ä»¶ä¸­çš„åº“è·¯å¾„å’Œåº“å
- ç¡®è®¤ `ThirdParty/lib/win32/` ä¸­æœ‰å¯¹åº”çš„ `.lib` æ–‡ä»¶
- æ£€æŸ¥å¹³å°æ˜¯å¦åŒ¹é…ï¼ˆx64 vs Win32ï¼‰

### 3. è¿è¡Œæ—¶é”™è¯¯ï¼šæ— æ³•åŠ è½½æ‰©å±•

**é”™è¯¯ä¿¡æ¯ï¼š**
```
LoadError: cannot load such file -- SUEX_HelloWorld
```

**å¯èƒ½åŸå› ï¼š**
1. **æ‰©å±•æ–‡ä»¶ä¸å­˜åœ¨**ï¼šæ£€æŸ¥ç¼–è¯‘è¾“å‡ºç›®å½•
2. **æ¶æ„ä¸åŒ¹é…**ï¼šç¡®ä¿æ‰©å±•ä¸ SketchUp çš„æ¶æ„ä¸€è‡´ï¼ˆéƒ½æ˜¯ x64ï¼‰
3. **Ruby ç‰ˆæœ¬ä¸åŒ¹é…**ï¼šæ‰©å±•å¿…é¡»ç”¨ä¸ SketchUp ç›¸åŒçš„ Ruby ç‰ˆæœ¬ç¼–è¯‘
4. **ç¼ºå°‘ä¾èµ– DLL**ï¼šWindows ä¸Šå¯èƒ½éœ€è¦ VC++ Runtime

**è§£å†³æ–¹æ¡ˆï¼š**
```ruby
# æ£€æŸ¥ Ruby ç‰ˆæœ¬
puts RUBY_VERSION  # åº”è¯¥ä¸ç¼–è¯‘é…ç½®åŒ¹é…

# æ£€æŸ¥å¹³å°
puts RUBY_PLATFORM

# å°è¯•åŠ è½½å¹¶æŸ¥çœ‹è¯¦ç»†é”™è¯¯
begin
  require 'SUEX_HelloWorld'
rescue LoadError => e
  puts e.message
  puts e.backtrace
end
```

### 4. SWIG ç¼–è¯‘é”™è¯¯

**é”™è¯¯ä¿¡æ¯ï¼š**
```
swig.exe: command not found
```

**è§£å†³æ–¹æ¡ˆï¼š**
- Windowsï¼šç¡®è®¤ `ThirdParty/bin/win32/swig/swig.exe` å­˜åœ¨
- macOSï¼šå®‰è£… SWIGï¼š`brew install swig`
- æ£€æŸ¥é¡¹ç›®ä¸­çš„ SWIG è·¯å¾„é…ç½®

### 5. é¡¹ç›®åä¸ Init å‡½æ•°ä¸åŒ¹é…

**é”™è¯¯ä¿¡æ¯ï¼š**
```
undefined symbol: Init_YourProjectName
```

**è§£å†³æ–¹æ¡ˆï¼š**
- ç¡®ä¿é¡¹ç›®åã€`Init_*()` å‡½æ•°åå’Œ `.def` æ–‡ä»¶ä¸­çš„å¯¼å‡ºåå®Œå…¨ä¸€è‡´
- ä¾‹å¦‚ï¼šé¡¹ç›®å `SUEX_HelloWorld` â†’ å‡½æ•°å `Init_SUEX_HelloWorld`

### 6. Windowsï¼šVC++ Runtime é—®é¢˜

**é—®é¢˜ï¼š** ç”¨æˆ·æœºå™¨ä¸Šç¼ºå°‘ VC++ Runtime

**è§£å†³æ–¹æ¡ˆï¼š**
- ä½¿ç”¨ `/MT`ï¼ˆé™æ€é“¾æ¥ï¼‰è€Œä¸æ˜¯ `/MD`
- æˆ–ç¡®ä¿ç”¨æˆ·å®‰è£…å¯¹åº”çš„ VC++ Runtime
- å‚è€ƒ README.md ä¸­çš„è¯¦ç»†è¯´æ˜

### 7. macOSï¼šæ¶æ„ä¸åŒ¹é…

**é—®é¢˜ï¼š** æ‰©å±•æ˜¯ x86_64ï¼Œä½† SketchUp æ˜¯ arm64ï¼ˆApple Siliconï¼‰

**è§£å†³æ–¹æ¡ˆï¼š**
- ä½¿ç”¨ Xcode çš„ Universal Binary é…ç½®
- æˆ–ä¸º arm64 å•ç‹¬ç¼–è¯‘ä¸€ä¸ªç‰ˆæœ¬

### 8. è°ƒè¯•æ—¶ SketchUp æ— æ³•å¯åŠ¨

**è§£å†³æ–¹æ¡ˆï¼š**
- æ£€æŸ¥é¡¹ç›®å±æ€§ä¸­çš„ SketchUp è·¯å¾„æ˜¯å¦æ­£ç¡®
- ç¡®è®¤ SketchUp å·²æ­£ç¡®å®‰è£…
- å°è¯•æ‰‹åŠ¨å¯åŠ¨ SketchUpï¼Œç„¶åé™„åŠ è°ƒè¯•å™¨ï¼ˆè°ƒè¯• > é™„åŠ åˆ°è¿›ç¨‹ï¼‰

---

## è¿›é˜¶ä¸»é¢˜

### åˆ›å»ºè‡ªå·±çš„æ‰©å±•

1. **å¤åˆ¶ Hello World é¡¹ç›®**
   - å¤åˆ¶æ•´ä¸ª `Hello World` æ–‡ä»¶å¤¹
   - é‡å‘½åä¸ºä½ çš„é¡¹ç›®å

2. **ä¿®æ”¹é¡¹ç›®æ–‡ä»¶**
   - é‡å‘½å `.vcxproj` æ–‡ä»¶
   - åœ¨ Visual Studio ä¸­æ‰“å¼€ï¼Œä¿®æ”¹é¡¹ç›®å
   - æ›´æ–° `.def` æ–‡ä»¶ä¸­çš„å¯¼å‡ºå

3. **ä¿®æ”¹æºä»£ç **
   - ä¿®æ”¹ `Init_*()` å‡½æ•°å
   - å®ç°ä½ çš„åŠŸèƒ½
   - æ›´æ–°æ¨¡å—åå’Œæ–¹æ³•å

4. **æ›´æ–°è§£å†³æ–¹æ¡ˆ**
   - åœ¨ Visual Studio ä¸­æ·»åŠ æ–°é¡¹ç›®
   - é…ç½® Ruby ç‰ˆæœ¬å±æ€§

### æ·»åŠ æ›´å¤š Ruby æ–¹æ³•

```cpp
// æ¥å—å‚æ•°çš„æ–¹æ³•
VALUE add_numbers(VALUE self, VALUE a, VALUE b) {
  int num_a = NUM2INT(a);
  int num_b = NUM2INT(b);
  return INT2NUM(num_a + num_b);
}

void Init_YourExtension() {
  VALUE mModule = rb_define_module("YourModule");
  
  // å®šä¹‰æ¥å— 2 ä¸ªå‚æ•°çš„æ–¹æ³•
  rb_define_module_function(mModule, "add_numbers", 
                            VALUEFUNC(add_numbers), 2);
}
```

### å¤„ç† Ruby å¯¹è±¡

```cpp
// åˆ›å»º Ruby æ•°ç»„
VALUE create_array() {
  VALUE arr = rb_ary_new();
  rb_ary_push(arr, INT2NUM(1));
  rb_ary_push(arr, INT2NUM(2));
  return arr;
}

// è®¿é—® Ruby å¯¹è±¡çš„å±æ€§
VALUE get_length(VALUE self, VALUE str) {
  return INT2NUM(RSTRING_LEN(str));
}
```

---

## å‚è€ƒèµ„æº

### å®˜æ–¹æ–‡æ¡£

- [Ruby C API æ–‡æ¡£](https://docs.ruby-lang.org/en/)
- [SWIG æ–‡æ¡£](http://www.swig.org/Doc/)
- [SketchUp Ruby API](https://developer.sketchup.com/)

### é¡¹ç›®æ–‡ä»¶è¯´æ˜

- `README.md` - é¡¹ç›®åŸºæœ¬è¯´æ˜
- `macOS.md` - macOS ç‰¹å®šè¯´æ˜
- `LICENSE` - MIT è®¸å¯è¯

### ç›¸å…³é¡¹ç›®

- [TestUp](https://github.com/SketchUp/testup-2) - SketchUp æµ‹è¯•æ¡†æ¶ï¼ˆåŒ…å« C æ‰©å±•ç¤ºä¾‹ï¼‰

---

## æ€»ç»“

è¿™ä¸ªé¡¹ç›®æä¾›äº†å®Œæ•´çš„ SketchUp Ruby C/C++ æ‰©å±•å¼€å‘ç¯å¢ƒï¼š

âœ… **å¼€ç®±å³ç”¨**ï¼šåŒ…å«æ‰€æœ‰å¿…éœ€çš„ Ruby å¤´æ–‡ä»¶å’Œåº“  
âœ… **å¤šç‰ˆæœ¬æ”¯æŒ**ï¼šæ”¯æŒ Ruby 1.8 åˆ° 3.2  
âœ… **è·¨å¹³å°**ï¼šWindows å’Œ macOS é…ç½®é½å…¨  
âœ… **ç¤ºä¾‹å®Œæ•´**ï¼šä»ç®€å•åˆ°å¤æ‚çš„ç¤ºä¾‹éƒ½æœ‰  
âœ… **è°ƒè¯•å‹å¥½**ï¼šé¢„é…ç½®äº†è°ƒè¯•è®¾ç½®  

æŒ‰ç…§æœ¬æŒ‡å—ï¼Œä½ åº”è¯¥èƒ½å¤Ÿï¼š
1. ç†è§£é¡¹ç›®ç»“æ„
2. ç¼–è¯‘ç¤ºä¾‹é¡¹ç›®
3. åœ¨ SketchUp ä¸­åŠ è½½å’Œæµ‹è¯•æ‰©å±•
4. åˆ›å»ºè‡ªå·±çš„æ‰©å±•

å¦‚æœ‰é—®é¢˜ï¼Œè¯·å‚è€ƒå¸¸è§é—®é¢˜éƒ¨åˆ†æˆ–æŸ¥çœ‹é¡¹ç›®ä¸­çš„æºä»£ç æ³¨é‡Šã€‚


